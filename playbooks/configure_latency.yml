---
# Network Latency Simulation using tc/netem
#
# Topology:
# - Phoenix DC1 (nodes 01-02) ↔ Phoenix DC2 (node 03): metro WAN latency
# - Phoenix cluster ↔ Dallas cluster: cross-country latency
#
- name: Configure Network Latency Simulation
  hosts: nodes
  become: true
  tasks:
    - name: Install iproute-tc package
      ansible.builtin.dnf:
        name: iproute-tc
        state: present

    - name: Clear existing tc rules
      ansible.builtin.shell: |
        tc qdisc del dev {{ network.interface }} root 2>/dev/null || true
      changed_when: false

    - name: Setup root qdisc with prio bands
      ansible.builtin.command: >
        tc qdisc add dev {{ network.interface }} root handle 1: prio bands 4

    - name: Add netem qdisc for metro latency (band 2)
      ansible.builtin.command: >
        tc qdisc add dev {{ network.interface }} parent 1:2 handle 20:
        netem delay {{ latency.metro.delay_ms }}ms {{ latency.metro.jitter_ms }}ms distribution normal

    - name: Add netem qdisc for cross-country latency (band 3)
      ansible.builtin.command: >
        tc qdisc add dev {{ network.interface }} parent 1:3 handle 30:
        netem delay {{ latency.cross_country.delay_ms }}ms {{ latency.cross_country.jitter_ms }}ms distribution normal

    # Phoenix DC1 nodes: add metro latency to DC2, cross-country to Dallas
    - name: "Phoenix DC1: Add metro latency filter to DC2"
      ansible.builtin.command: >
        tc filter add dev {{ network.interface }} parent 1:0 protocol ip prio 1
        u32 match ip dst {{ hostvars['tanzu-node-03']['ansible_host'] }}/32
        flowid 1:2
      when: inventory_hostname in groups['phoenix_dc1']

    - name: "Phoenix DC1: Add cross-country latency filter to Dallas"
      ansible.builtin.command: >
        tc filter add dev {{ network.interface }} parent 1:0 protocol ip prio 2
        u32 match ip dst {{ hostvars[item]['ansible_host'] }}/32
        flowid 1:3
      loop: "{{ groups['normal_cluster'] }}"
      when: inventory_hostname in groups['phoenix_dc1']

    # Phoenix DC2 node: add metro latency to DC1, cross-country to Dallas
    - name: "Phoenix DC2: Add metro latency filter to DC1"
      ansible.builtin.command: >
        tc filter add dev {{ network.interface }} parent 1:0 protocol ip prio 1
        u32 match ip dst {{ hostvars[item]['ansible_host'] }}/32
        flowid 1:2
      loop: "{{ groups['phoenix_dc1'] }}"
      when: inventory_hostname in groups['phoenix_dc2']

    - name: "Phoenix DC2: Add cross-country latency filter to Dallas"
      ansible.builtin.command: >
        tc filter add dev {{ network.interface }} parent 1:0 protocol ip prio 2
        u32 match ip dst {{ hostvars[item]['ansible_host'] }}/32
        flowid 1:3
      loop: "{{ groups['normal_cluster'] }}"
      when: inventory_hostname in groups['phoenix_dc2']

    # Dallas nodes: add cross-country latency to all Phoenix nodes
    - name: "Dallas: Add cross-country latency filter to Phoenix"
      ansible.builtin.command: >
        tc filter add dev {{ network.interface }} parent 1:0 protocol ip prio 2
        u32 match ip dst {{ hostvars[item]['ansible_host'] }}/32
        flowid 1:3
      loop: "{{ groups['stretched_cluster'] }}"
      when: inventory_hostname in groups['normal_cluster']

    - name: Verify tc configuration
      ansible.builtin.command: tc qdisc show dev {{ network.interface }}
      register: tc_qdisc
      changed_when: false

    - name: Show tc configuration
      ansible.builtin.debug:
        var: tc_qdisc.stdout_lines

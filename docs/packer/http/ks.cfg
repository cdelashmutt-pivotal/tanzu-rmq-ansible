# RHEL 9 Kickstart for Tanzu RabbitMQ Template
# Minimal installation with cloud-init support

# Installation settings
text
eula --agreed
firstboot --disabled
reboot

# Localization
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Network - DHCP for installation, cloud-init handles final config
network --bootproto=dhcp --device=link --activate --onboot=yes

# Root password (temporary - cloud-init manages users)
rootpw --plaintext packer

# Disk partitioning
zerombr
clearpart --all --initlabel
autopart --type=lvm

# Package selection - minimal plus required packages
%packages --ignoremissing
@^minimal-environment
cloud-init
cloud-utils-growpart
python3
open-vm-tools
-plymouth
-biosdevname
%end

# Post-installation script
%post --log=/root/ks-post.log

# Enable VMware tools
systemctl enable vmtoolsd

# Configure cloud-init for OVF datasource
cat > /etc/cloud/cloud.cfg.d/99_vmware.cfg << 'EOF'
datasource_list: [ OVF, None ]
datasource:
  OVF:
    allow_raw_data: true
EOF

# Disable cloud-init network config (we use runcmd in userdata)
cat > /etc/cloud/cloud.cfg.d/99_disable_network.cfg << 'EOF'
network:
  config: disabled
EOF

# Enable cloud-init services
systemctl enable cloud-init-local
systemctl enable cloud-init
systemctl enable cloud-config
systemctl enable cloud-final

# Configure NetworkManager to use keyfile plugin
cat > /etc/NetworkManager/NetworkManager.conf << 'EOF'
[main]
plugins=keyfile

[keyfile]
unmanaged-devices=none
EOF

# Install seal script for future use
cat > /root/seal.sh << 'SEAL'
#!/bin/bash
set -e
echo "Sealing RHEL 9 Template..."
cloud-init clean --logs --seed
truncate -s 0 /etc/machine-id
rm -f /var/lib/dbus/machine-id
rm -f /etc/ssh/ssh_host_*
rm -f /var/lib/NetworkManager/*
rm -f /etc/NetworkManager/system-connections/*
dnf clean all
rm -rf /var/log/* /tmp/* /var/tmp/*
journalctl --vacuum-time=1s 2>/dev/null || true
rm -f /root/.bash_history /home/*/.bash_history
history -c
sync
shutdown -h now
SEAL
chmod +x /root/seal.sh

%end
